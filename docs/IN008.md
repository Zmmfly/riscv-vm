# RISC-V 浮点运算实现笔记
下面就以 格式、分类、四则运算、比较运算进行记录

## 二进制格式
参考IN007
|  type  |    Sign     |   Exponent   | Faction(Mantissa) |
| :----: | :---------: | :----------: | :---------------: |
|  fp16  | 1b`[15:15]` | 5b`[14:10]`  |    10b`[9:0]`     |
| float  | 1b`[31:31]` | 8b`[30:23]`  |    23b`[22:0]`    |
| double | 1b`[63:63]` | 11b`[62:52]` |    52b`[51:0]`    |

## 分类
在RISC-V spec中，描述了其浮点规范遵循 `IEEE 754-2008`
依据：
1. `IEEE 754-2008`文档第25页，`5.7.2 General operations`
2. 参考1 ~ 参考6
3. `Volume1_riscv-spec-20191213.pdf` 中的 `11.3 NaN Generation and Propagation` 章节

浮点数值有以下几种分类：

1. NaN
   1. 编码
      - S: `*`
      - E: 全为 `1`
      - M: 非0任意值
   2. 子类
      1. signalingNaN
         - S: `*`
         - E: 全为 `1`
         - M: MSB为 `0`, 其余取决于实现
           - ARM: MSB为 `0`, LSB为 `1`, 其余位为 `0`, 单精度例：
           - X86: MSB为 `0`, MSB-1为 `1`, 其余位为 `0`, 单精度示例: `0x7fa00000`
      2. quietNaN
         - S: `*`
         - E: 全为 `1`
         - M: MSB为 `1`, 其余取决于实现
           - ARM: MSB为 `1`, LSB为 `1`, 其余位为 `0`
           - X86: MSB为 `1`, 其余位为 `0`, 单精度示例: `0x7fc00000`
      3. Canonical NaN
         这个是RSIC-V中定义的特例, 并且RISC-V规范中要求始终支持且应是默认模式, 详情见RISC-V规范文档
         关于这个Canonical NaN, RISC-V要求在生成NaN时作为默认实现, 可简化硬件
         - S: `1`
         - E: 全为 `1`
         - M: 除尾数除最高位为1外, 其它位全为0 
           - RISC-V: 单精度示例: `0x7fc00000`
2. negativeInfinity
   - S: `1`
   - E: 全为`1`
   - M: 全为`0`
3. negativeNormal
   - S: `1`
   - E: 不全为`0` 且 不全为`1`
   - M: `*`
4. negativeSubnormal
   - S: `1`
   - E: 全为`0`
   - M: 非全`0`任意值
5. negativeZero
   - S: `1`
   - E: 全`0`
   - M: 全`0`
6.  positiveZero
   - S: `0`
   - E: 全`0`
   - M: 全`0`
7.  positiveSubnormal
   - S: `0`
   - E: 全`0`
   - M: 非全`0`任意值
8.  positiveNormal
   - S: `0`
   - E: 不全为`0` 且 不全为`1`
   - M: `*`
9.  positiveInfinity
   - S: `0`
   - E: 全为`1`
   - M: 全为`0`

## 四则运算

以下分别归纳常规情况下的运算`规约数(Normal) & 次归约数(Subnormal)`, 以及非常规`(Infinity/Zero/NaN)` 情况下的运算

**约定:**

以下 `aS`, `aE`, `aM` 分别表示`a`的: `符号位` `指数值` `尾数值`, 其它数类同

#### 规约数 & 次归约数

##### 加法
`a + b = c`
当前假设 `a` 与 `b`为正数, 按以下步骤进行
```
# 1. 将指数较小数的位数 `M` 右移 `abs(aE - bE)` 比特
# 2. 结果的指数设为两数最大的指数
# 3. 将两尾数补齐前置隐含`1`后相加
# 4. 如果有必要, 对结果进行舍入以及规格化

aM = add_hidden_prefix(aM)
bM = add_hidden_prefix(bM)
(M of min(aE, bE)) >>= max(aE, bE) - min(aE, bE)
cE = max(aE, bE)
cM = aM + bM

if is_ovf(cM)
   cE += 1
   cM >>= 1

round(cS, cE, cM)
c = normalize(cS, cE, cM)
```

以上即为`正数`与`正数`的加法步骤

对于`负数`与`负数`的加法, 方法相同, 注意符号位即可

对于`正数`与`负数`或`负数`与`正数`的加法
在第3步, 根据 `aM` 与 `bM`的大小, 选择是 `aM` 减 `bM`, 还是 `bM` 减 `aM`
最终的符号位需要根据`a`与`b`的符号位, 以及`aM`与`bM`的大小, 综合判断

具体例子参考`IN007`

##### 减法
a - b = c
b符号位取反, 作为加法运算


##### 乘法
a x b = c
```
# 1. 两数的指数相加并减去127 `这里的127即为bias`
# 2. 将尾数补齐前置隐含`1`后相乘, 并以浮点格式定义的尾数宽度作为位移长度, 向右位移
# 3. 检查尾数乘积位移后是否溢出包含隐含`1`所能表达的范围(单精度即24位), 溢出则将尾数再次右移1位, 并向指数加`1`
# 4. 如果有必要, 对结果进行舍入以及规格化

cS = aS ^ bS
cE = aE + bE - 127
aM = add_hidden_prefix(aM)
bM = add_hidden_prefix(bM)
cM = (aM x bM) >> widthof(M)

if is_ovf(cM)
   cM >>= 1
   cE += 1

round(cS, cE, cM)
c = normalize(cS, cE, cM)
```

##### 乘法
a / b = c
```
# 1. 指数相减并加上127
# 2. 将尾数补齐前置隐含`1`后相除 `aM <<= 31; 如果aM < bM, cE减一, 并aM <<= 1, 即一共位移32位`
# 3. 对结果进行舍入规格化

cS = aS ^ bS
cE = aE - bE + 127
aM = add_hidden_prefix(aM)
bM = add_hidden_prefix(bM)

round(cS, cE, cM)
c = normalize(cS, cE, cM)
```

## 优化
乘法用于数字电路中, 如果按传统方法多次相乘累加计算, 乘法单指令时钟周期将增加, 
这也会带来当涉及乘法运算指令时, 增加流水线停顿周期, 降低能效

**参考**
1. https://zh.wikipedia.org/wiki/IEEE_754
2. https://en.wikipedia.org/wiki/IEEE_754-1985
3. https://en.wikipedia.org/wiki/Single-precision_floating-point_format
4. https://en.wikipedia.org/wiki/NaN
5. https://stackoverflow.com/questions/18118408/what-is-the-difference-between-quiet-nan-and-signaling-nan
6. https://blog.csdn.net/Hide_in_Code/article/details/125896007
7. https://zhuanlan.zhihu.com/p/343049681
8. https://zlogs.net/blog/20/10151300/index.html
9. https://www.cnblogs.com/alking1001/p/13461906.html
10. https://blog.csdn.net/wangpeng246300/article/details/129532697
11. https://blog.csdn.net/weixin_45500205/article/details/123661905
12. https://polarisxu.studygolang.com/posts/basic/diagram-float-point/
13. https://csbabel.wordpress.com/2009/08/19/an-intro-to-ieee-floating/
14. https://www.52pojie.cn/thread-1839972-1-1.html
